
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-Chapter Viewer</title>

<style>
body {
  background:#121212;
  color:#fff;
  font-family:Arial, sans-serif;
  text-align:center;
  margin:0;
}
.container {
  display:flex;
  flex-direction:column;
  align-items:center;
}
img {
  max-width:100%;
  margin-bottom:6px;
  box-shadow:0 2px 4px rgba(0,0,0,0.8);
}
h2 {
  margin:25px 0 15px;
  color:#ffcc00;
}
input,button {
  margin:6px;
  padding:10px;
  font-size:16px;
}
button {
  background:#ff4081;
  color:#fff;
  border:none;
  cursor:pointer;
}
#status {
  position:fixed;
  bottom:15px;
  right:15px;
  background:rgba(255,255,255,.7);
  color:#000;
  padding:6px 12px;
  border-radius:20px;
  z-index:9999;
}
#toTopBtn {
  position:fixed;
  bottom:15px;
  left:15px;
  padding:8px 12px;
  border-radius:20px;
  font-weight:bold;
  cursor:pointer;
  z-index:9999;
}
</style>
</head>

<body>

<h1>Multi-Chapter Viewer</h1>

<input id="baseUrl" placeholder="Chapter base URL (ending with /)"><br>
<input id="startPage" type="number" value="1">
<input id="endPage" type="number" placeholder="End page"><br>
<button onclick="loadChapter()">Load Chapter</button>

<div class="container" id="imageContainer"></div>

<div id="status">⏳</div>
<button id="toTopBtn"
  onclick="window.scrollTo({top:0,behavior:'smooth'})">↑ 0</button>

<script>
const formats = ["png","jpg","jpeg","webp"];
const container = document.getElementById("imageContainer");
const status = document.getElementById("status");
const toTopBtn = document.getElementById("toTopBtn");

let chapterCount = 0;

// page tracker
const observer = new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      toTopBtn.textContent = "↑ " + e.target.dataset.page;
    }
  });
},{threshold:.5});

// load ONE page safely
function loadOneImage(baseUrl, page, chapterLabel) {
  return new Promise(resolve => {
    const img = document.createElement("img");
    img.dataset.page = `${chapterLabel}-${page}`;
    img.loading = "lazy";

    let idx = 0;

    img.onerror = () => {
      idx++;
      if (idx < formats.length) {
        img.src = `${baseUrl}${page}.${formats[idx]}`;
      } else {
        resolve(); // page missing
      }
    };

    img.onload = () => {
      observer.observe(img);
      resolve();
    };

    container.appendChild(img);
    img.src = `${baseUrl}${page}.${formats[0]}`;
  });
}

async function loadChapter(){
  let baseUrl = document.getElementById("baseUrl").value.trim();
  const start = +document.getElementById("startPage").value;
  const end = +document.getElementById("endPage").value;

  if (!baseUrl.endsWith("/")) baseUrl += "/";
  if (!baseUrl || !start || !end || end < start){
    alert("Invalid input");
    return;
  }

  chapterCount++;
  const chapterLabel = `C${chapterCount}`;

  // chapter title
  const title = document.createElement("h2");
  title.textContent = `Chapter ${chapterCount}`;
  container.appendChild(title);

  // slow sequential loading
  for (let page = start; page <= end; page++) {
    status.textContent = `⏳ ${chapterLabel}-${page}`;
    await loadOneImage(baseUrl, page, chapterLabel);

    // throttle (IMPORTANT)
    await new Promise(r => setTimeout(r, 100));
  }

  status.textContent = `✅ Chapter ${chapterCount} loaded`;
  setTimeout(()=>status.textContent="⏳",1200);
}
</script>

</body>
</html>
